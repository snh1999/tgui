
# 12. Testing Strategy (Generated by Kimi k2)

## 12.1 Manual Testing Checklist
**Run before each release**:

- [ ] **Command CRUD**:
  - [ ] Create command â†’ appears in list
  - [ ] Edit command â†’ changes saved
  - [ ] Delete command â†’ removed from list
  - [ ] Search command â†’ filters correctly

- [ ] **Execution**:
  - [ ] Run simple command (`echo test`) â†’ logs appear
  - [ ] Run in wrong directory â†’ shows error
  - [ ] Run long command (`sleep 10`) â†’ can stop mid-execution
  - [ ] Run command with spaces in path â†’ works
  - [ ] **Stress Test**
    - [ ] Spawn 50 `yes` commands â†’ UI remains responsive (scroll, click)
    - [ ] Monitor RAM with `htop` â†’ stays under 100MB total
    - [ ] Kill all â†’ wait 10s â†’ no zombie processes (`ps aux | grep defunct`)
    
- [ ] **Background Operation**
  - [ ] Run `tail -f /var/log/syslog` â†’ close main window â†’ verify `tail` still running (`ps aux`)
  - [ ] Wait 1 minute â†’ reopen window â†’ logs show new entries
  - [ ] Click tray icon â†’ window reopens â†’ process still listed

- [ ] **Categories & Favorites**:
  - [ ] Star command â†’ moves to favorites
  - [ ] Filter by category â†’ shows only that category
  - [ ] Create new category â†’ appears in dropdown

- [ ] **Templates**:
  - [ ] Create template â†’ saved
  - [ ] Apply template â†’ all commands created in target directory
  - [ ] Built-in templates work
  
- [ ] **Multi-Window**
  - [ ] Open 3 log windows â†’ drag to different monitors â†’ all update live
  - [ ] Close main window â†’ log windows stay open
  - [ ] Close all log windows â†’ app stays in tray
  - [ ] Click "Quit" in tray â†’ all processes killed, app exits
  
- [ ] Process Management
  - [ ] Spawn `sleep 30` â†’ PID appears â†’ kill â†’ process dies within 2s
  - [ ] Spawn `false` â†’ process exits with code 1 â†’ UI shows "Error"
  - [ ] Spawn `npm run build:watch` â†’ kill â†’ webpack child processes die too

- [ ] **Edge Cases**:
  - [ ] Command with single quotes: `echo 'hello'`
  - [ ] Command with env vars: `API_KEY=test ./script.sh`
  - [ ] Command that fails: `false` â†’ shows exit code
  
- [ ] **Distribution**
  - [ ] Install `.deb` on Ubuntu â†’ app appears in launcher
  - [ ] Install `.rpm` on Fedora â†’ `rpm -q yourapp` shows installed
  - [ ] Run AppImage â†’ works without installation
  - [ ] Auto-update test (Windows): publish v0.1.0 â†’ v0.1.1 â†’ verify update prompt

## 12.2 Automated Tests 
**Philosophy**: No dedicated QA team â†’ **automated tests are critical**. E2E-first, focus on **user-critical paths**. Coverage is secondary to confidence.

### 12.2.1 Test Pyramid

## Test Pyramid 
```bash
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Manual QA
    â”‚   E2E Tests     â”‚  5-7 critical journeys
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Component Tests â”‚  Key Vue components
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚   Unit Tests    â”‚  Rust business logic
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 12.2.2 End-to-End Tests (E2E)

**Tool**: **Playwright** + `@tauri-apps/api`

**Setup**:
```bash
npm install -D @playwright/test
```

**Test**:
```typescript
// tests/e2e/run-command.spec.ts
import { test, expect } from '@playwright/test';
import { spawn } from 'child_process';
import treeKill from 'tree-kill';

let tauriProcess: any;

test.beforeAll(async () => {
  // Start Tauri app before tests
  tauriProcess = spawn('cargo', ['tauri', 'dev'], { cwd: 'src-tauri' });
  await new Promise(resolve => setTimeout(resolve, 5000)); // Wait for startup
});

test.afterAll(async () => {
  treeKill(tauriProcess.pid);
});

test('user can spawn command and see logs', async ({ page }) => {
  await page.goto('tauri://localhost'); // Tauri protocol

  // Click "Run Command"
  await page.click('text=Run Command...');

  // Type command
  await page.fill('input[placeholder="e.g., npm start"]', 'echo "hello"');

  // Click "Run"
  await page.click('button:has-text("Run")');

  // Wait for process to appear in list
  await page.waitForSelector('text=echo "hello"', { timeout: 5000 });

  // Click "View Logs"
  await page.click('text="ðŸ“„ View Logs"');

  // Verify log window opens
  const logWindow = await page.waitForEvent('popup');
  await expect(logWindow).toContainText('hello');
});
```

**Critical User Journeys** (Must pass before each release):

**Journey 1: Save & Execute Command** (FR-01, FR-02, FR-06)

```javascript
test('save and execute command', async () => {
  // Setup: Launch app
  const app = await tauri.launch()
  
  // 1. Create command
  await app.click('[data-test="new-command"]')
  await app.fill('[data-test="name-input"]', 'Test Server')
  await app.fill('[data-test="command-input"]', 'python3')
  await app.fill('[data-test="args-input"]', '-m http.server')
  await app.fill('[data-test="dir-input"]', '/tmp')
  await app.click('[data-test="save-command"]')
  
  // 2. Verify saved
  const commands = await app.getCommandList()
  assert(commands.includes('Test Server'))
  
  // 3. Execute
  await app.click('[data-test="run-Test Server"]')
  
  // 4. Verify running
  await app.waitFor('[data-test="status-Test Server"]', 'Running')
  const pid = await app.getPID('Test Server')
  assert(pid > 0)
  
  // 5. Verify logs stream
  await app.waitForLog(pid, 'Serving HTTP on', 1000)
  
  // 6. Cleanup
  await app.stopProcess(pid)
})
```

**Journey 2: Journey 2: Background Process Persistence** (FR-08)
```typescript
test('process survives window close', async () => {
  // 1. Start long-running process
  const pid = await app.spawnCommand('sleep 1000')
  
  // 2. Close main window
  await app.closeWindow()
  await app.wait(500) // Give time for close
  
  // 3. Verify process still running (shell out to ps)
  const isRunning = await app.isProcessAlive(pid)
  assert(isRunning)
  
  // 4. Reopen window
  await app.showWindow()
  
  // 5. Verify logs still streaming
  const logs = await app.getLogs(pid)
  assert(logs.length > 0)
  
  // 6. Cleanup
  await app.killProcess(pid, force=true)
})
```

**Journey 3: Journey 3: Template Application** (FR-05)

```typescript
test('apply python template', async () => {
  // 1. Apply template
  await app.click('[data-test="templates"]')
  await app.click('[data-test="apply-Python Development"]')
  await app.fill('[data-test="var-project_dir"]', '/tmp/test-project')
  await app.click('[data-test="confirm-apply"]')
  
  // 2. Verify commands created
  const commands = await app.getCommandList()
  assert(commands.includes('Create venv'))
  assert(commands.includes('Install Dependencies'))
  
  // 3. Verify directory substitution
  const cmd = await app.getCommand('Create venv')
  assert(cmd.working_directory === '/tmp/test-project')
})
```

**Journey 4: Journey 4: Search & Favorites** (FR-04)

```typescript
test('search and favorite commands', async () => {
  // Pre-populate with 50 commands
  await app.importCommands('test-data-50-commands.json')
  
  // 1. Search
  await app.fill('[data-test="search"]', 'docker')
  const results = await app.getVisibleCommands()
  assert(results.every(c => c.includes('docker')))
  assert(results.length < 50)
  
  // 2. Favorite
  await app.click('[data-test="star-Build Docker"]')
  const favorites = await app.getFavorites()
  assert(favorites.includes('Build Docker'))
  
  // 3. Performance check
  const duration = await app.measureSearch('docker', 100)
  assert(duration < 200) // ms
})
```

**Journey 5: Journey 5: Process Termination** (FR-07)

```typescript
test('stop and force kill process', async () => {
  const pid = await app.spawnCommand('sleep 1000')
  
  // 1. Graceful stop
  await app.click('[data-test="stop"]')
  await app.waitForStatus(pid, 'Stopped', 2000)
  assert(await app.isProcessAlive(pid) === false)
  
  // 2. Force kill hung process
  const hungPid = await app.spawnCommand('cat > /dev/null') // Blocks on stdin
  await app.rightClick('[data-test="force-kill"]')
  await app.acceptDialog()
  await app.waitForStatus(hungPid, 'Stopped', 500)
  assert(await app.isProcessAlive(hungPid) === false)
})
```

**Run**: `npx playwright test`

#### 12.2.3 Component Tests (Vue)

**Tools**:  Vitest + Vue Testing Library

**Strategy**: Write tests for key component coverage

**Log Viewer**
```typeScript
test('displays logs with color coding', () => {
  const logs = [
    { line: 'Build success', is_stderr: false, timestamp: 1000 },
    { line: 'ERROR: Failed', is_stderr: true, timestamp: 1001 }
  ]
  const wrapper = mount(LogViewer, { props: { logs } })
  
  expect(wrapper.find('.log-stdout').exists()).toBe(true)
  expect(wrapper.find('.log-stderr').classes()).toContain('text-red')
})

test('auto-scroll stops when user scrolls up', async () => {
  const wrapper = mount(LogViewer, { props: { logs: largeArray } })
  await wrapper.find('.log-container').trigger('scroll-up')
  
  expect(wrapper.vm.autoScroll).toBe(false)
})
```

**Command List**
```typeScript
test('filters commands by search term', async () => {
  const commands = ref(mockCommands)
  const wrapper = mount(CommandList, { props: { commands } })
  
  await wrapper.find('[data-test="search"]').setValue('docker')
  
  expect(wrapper.findAll('.command-card').length).toBe(2) // only docker commands
})
```

#### 12.2.4 Unit Tests (Rust Backend)

**Tools**: Built-in cargo test (or tokio test)

**Run**: `cargo test` in `src-tauri/`

**Coverage goals**:
- **Process spawn**: Test success, failure (command not found), argument parsing
- **Signal handling**: Test SIGTERM, SIGKILL, process group kill
- **State management**: Test adding/removing processes from HashMap

#### 12.2.1.2 Integration Tests (Optional, Tauri Frontend â†” Backend)

**Tool**: Use `@tauri-apps/api` in Jest tests

**Run**: `pnpm test` in root

**Test**:
- **Data flow**: Frontend invokes command â†’ backend spawns â†’ frontend receives PID
- **Event streaming**: Backend emits log â†’ frontend receives and renders
- **Menu actions**: Click "Kill" â†’ backend receives signal â†’ process dies




### 12.2.5 Test Automation in CI

**.github/workflows/test.yml**:
```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm
      
      - name: Install deps
        run: |
          pnpm install
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev
      
      # 1. Rust unit tests
      - name: Rust unit tests
        run: cargo test --manifest-path src-tauri/Cargo.toml
      
      # 2. Rust linting
      - name: Rust linting
        run: |
          cargo fmt --manifest-path src-tauri/Cargo.toml -- --check
          cargo clippy --manifest-path src-tauri/Cargo.toml -- -D warnings
      
      # 3. Frontend unit tests
      - name: Frontend tests
        run: pnpm test
      
      # 4. Security audit
      - name: Security audit
        run: |
          cargo install cargo-audit
          cargo audit
          pnpm audit --audit-level high
      
      # 5. Build test (ensure it compiles)
      - name: Build test
        run: pnpm tauri build --debug
```

### 12.2.6 Others

1. **Test Data**
  - Seed database for E2E tests:
  - Mock processes for testing:
    - `test-slow.sh`: `sleep 100` (for stop tests)
    - `test-output.sh`: `for i in {1..10000}; do echo "line $i"; done` (for log buffer)
    - `test-error.sh`: `echo "ERROR: failed" >&2; exit 1`  (for error handling)

2. Known Limitations (These should fail gracefully):
  - Log buffer overflow (10,001st line) â†’ drops oldest silently
  - Database locked (rare) â†’ retry once, then show error
  - Process exits before logs flushed â†’ last lines may be lost


## 12.3 Bug Tracking

**Use GitHub Issues with labels**:
- `bug/critical`: Security issue or crash â†’ fix within 24h
- `bug/major`: Feature broken â†’ fix within 7 days
- `bug/minor`: UI glitch â†’ fix within 30 days

**Template for bug reports**:
```markdown
**Bug Report Template**
OS: [e.g., Ubuntu 22.04]
Version: [e.g., v0.1.0]
Steps:
1. ...
2. ...
Expected: ...
Actual: ...
Logs: Attach `~/.config/yourapp/logs/` if relevant
```
